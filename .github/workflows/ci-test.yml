name: "ðŸ§ª CI Tests - Chimera Desktop Assistant"

on:
  push:
    branches: [main, dev, "claude/*"]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write

jobs:
  test:
    name: "Test Installation & UI"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
        node-version: ["20"]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ðŸ“¦ Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ðŸ”§ Install uv (Python package manager)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: âš™ï¸ Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "âœ… Ollama installed"

      - name: ðŸ§  Start Ollama & pull test model
        run: |
          # Start Ollama in background
          ollama serve &
          OLLAMA_PID=$!
          echo "OLLAMA_PID=$OLLAMA_PID" >> $GITHUB_ENV

          # Wait for Ollama to be ready
          echo "â³ Waiting for Ollama to start..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:11434/api/tags >/dev/null 2>&1; then
              echo "âœ… Ollama is ready"
              break
            fi
            sleep 1
          done

          # Pull a lightweight model for testing
          echo "ðŸ“¥ Pulling gemma:2b model..."
          ollama pull gemma:2b

          # Verify model is available
          ollama list
          echo "âœ… Test model ready"

      - name: ðŸ”¨ Install Python dependencies
        run: |
          uv sync
          echo "âœ… Python dependencies installed"

      - name: ðŸ“¦ Install Frontend dependencies
        run: |
          cd frontend
          npm ci
          echo "âœ… Frontend dependencies installed"

      - name: ðŸ§ª Run Python unit tests
        run: |
          uv run pytest tests/ -v --tb=short
        env:
          CHIMERA_DEFAULT_PROVIDER: ollama
          OLLAMA_BASE_URL: http://127.0.0.1:11434
          OLLAMA_MODEL: gemma:2b

      - name: ðŸš€ Start Chimera backend (background)
        run: |
          uv run chimera-serve &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV

          # Wait for backend to be ready
          echo "â³ Waiting for backend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/health >/dev/null 2>&1; then
              echo "âœ… Backend is ready"
              break
            fi
            sleep 1
          done
        env:
          CHIMERA_DEFAULT_PROVIDER: ollama
          OLLAMA_BASE_URL: http://127.0.0.1:11434
          OLLAMA_MODEL: gemma:2b

      - name: ðŸŽ¨ Build frontend
        run: |
          cd frontend
          npm run build
          echo "âœ… Frontend built successfully"

      - name: ðŸŒ Start frontend dev server (background)
        run: |
          cd frontend
          npm run dev &
          FRONTEND_PID=$!
          echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV

          # Wait for frontend to be ready
          echo "â³ Waiting for frontend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:5173 >/dev/null 2>&1; then
              echo "âœ… Frontend is ready"
              break
            fi
            sleep 1
          done

      - name: ðŸ“¸ Install Playwright for UI testing
        run: |
          cd frontend
          npx playwright install --with-deps chromium
          echo "âœ… Playwright installed"

      - name: ðŸ§ª Run UI screenshot tests
        run: |
          cd frontend
          npx playwright test
        env:
          CI: true

      - name: ðŸ“Š Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-screenshots-${{ matrix.python-version }}-${{ matrix.node-version }}
          path: frontend/test-results/
          retention-days: 7

      - name: ðŸ§¹ Cleanup processes
        if: always()
        run: |
          # Kill background processes
          kill ${{ env.BACKEND_PID }} || true
          kill ${{ env.FRONTEND_PID }} || true
          kill ${{ env.OLLAMA_PID }} || true
          echo "âœ… Cleanup complete"

      - name: ðŸ“ˆ Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            test-results/**/*.xml
            frontend/test-results/**/*.xml

  lint:
    name: "Lint & Format Check"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ”§ Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ðŸ”¨ Install dependencies
        run: |
          uv sync --dev
          cd frontend && npm install

      - name: ðŸ§¹ Run Python linting (ruff)
        run: |
          uv run ruff check backend/ tests/

      - name: ðŸŽ¨ Run Python formatting check (black)
        run: |
          uv run black --check backend/ tests/

      - name: âœ¨ Run frontend linting (eslint)
        run: |
          cd frontend
          npm run lint

  security:
    name: "Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”’ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ“¤ Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
